// SPDX-License-Identifier: MIT
pragma solidity ^0.8.4;

import "./utils/SoladyTest.sol";
import {LibBit} from "../src/utils/LibBit.sol";

contract LibBitTest is SoladyTest {
    function testFLS() public {
        assertEq(LibBit.fls(0xff << 3), 10);
        for (uint256 i = 1; i < 255; i++) {
            assertEq(LibBit.fls((1 << i) - 1), i - 1);
            assertEq(LibBit.fls((1 << i)), i);
            assertEq(LibBit.fls((1 << i) + 1), i);
        }
        assertEq(LibBit.fls(0), 256);
    }

    function testCLZ() public {
        for (uint256 i = 1; i < 255; i++) {
            assertEq(LibBit.clz((1 << i) - 1), 255 - (i - 1));
            assertEq(LibBit.clz((1 << i)), 255 - i);
            assertEq(LibBit.clz((1 << i) + 1), 255 - i);
        }
        assertEq(LibBit.clz(0), 256);
    }

    function testFFS() public {
        assertEq(LibBit.ffs(0xff << 3), 3);
        uint256 brutalizer = uint256(keccak256(abi.encode(address(this), block.timestamp)));
        for (uint256 i = 0; i < 256; i++) {
            assertEq(LibBit.ffs(1 << i), i);
            assertEq(LibBit.ffs(type(uint256).max << i), i);
            assertEq(LibBit.ffs((brutalizer | 1) << i), i);
        }
        assertEq(LibBit.ffs(0), 256);
    }

    function testPopCount(uint256 x) public {
        uint256 c;
        unchecked {
            for (uint256 t = x; t != 0; c++) {
                t &= t - 1;
            }
        }
        assertEq(LibBit.popCount(x), c);
    }

    function testPopCount() public {
        unchecked {
            for (uint256 i = 1; i < 256; ++i) {
                assertEq(LibBit.popCount((1 << i) | 1), 2);
            }
        }
    }

    function testIsPo2(uint8 a, uint8 b) public {
        unchecked {
            uint256 x = (1 << uint256(a)) | (1 << uint256(b));
            if (a == b) {
                assertTrue(LibBit.isPo2(x));
            } else {
                assertFalse(LibBit.isPo2(x));
            }
        }
    }

    function testIsPo2(uint256 x) public {
        uint256 c;
        unchecked {
            for (uint256 t = x; t != 0; c++) {
                t &= t - 1;
            }
        }
        assertEq(LibBit.isPo2(x), c == 1);
    }

    function testIsPo2() public {
        assertFalse(LibBit.isPo2(0));
        assertFalse(LibBit.isPo2(type(uint256).max));
        unchecked {
            for (uint256 i; i < 256; ++i) {
                uint256 x = 1 << i;
                assertTrue(LibBit.isPo2(x));
                assertFalse(LibBit.isPo2(~x));
            }
        }
    }

    function testAnd(bool v, bool w, bool x, bool y) public {
        assertEq(LibBit.and(x, y), x && y);
        assertEq(LibBit.and(w, x, y), w && x && y);
        assertEq(LibBit.and(v, w, x, y), v && w && x && y);
        assertEq(LibBit.rawAnd(x, y), LibBit.and(x, y));
    }

    function testAnd() public {
        unchecked {
            for (uint256 t; t != 100; ++t) {
                uint256 i = _random();
                uint256 j = _random();
                uint256 k = _random();
                bool a = i < j;
                bool b = j < k;
                assertEq(LibBit.and(a, b), i < j && j < k);
            }
        }
    }

    function testOr(bool v, bool w, bool x, bool y) public {
        assertEq(LibBit.or(x, y), x || y);
        assertEq(LibBit.or(w, x, y), w || x || y);
        assertEq(LibBit.or(v, w, x, y), v || w || x || y);
        assertEq(LibBit.rawOr(x, y), LibBit.or(x, y));
    }

    function testOr() public {
        unchecked {
            for (uint256 t; t != 100; ++t) {
                uint256 i = _random();
                uint256 j = _random();
                uint256 k = _random();
                bool a = i < j;
                bool b = j < k;
                assertEq(LibBit.or(a, b), i < j || j < k);
            }
        }
    }

    function testAutoClean(uint256 x, uint256 y) public {
        bool xCasted;
        bool yCasted;
        /// @solidity memory-safe-assembly
        assembly {
            xCasted := x
            yCasted := y
        }
        bool result = LibBit.and(true, LibBit.or(xCasted, yCasted));
        assertEq(result, xCasted || yCasted);
    }

    function testReturnsBool() public {
        bool result;
        /// @solidity memory-safe-assembly
        assembly {
            mstore(0x00, 0x40b98a2f)
            mstore(0x20, 123)
            pop(staticcall(gas(), address(), 0x1c, 0x24, 0x00, 0x20))
            result := eq(mload(0x00), 1)
        }
        assertTrue(result);
    }

    function returnsBool(uint256 i) public pure returns (bool b) {
        /// @solidity memory-safe-assembly
        assembly {
            b := i
        }
    }

    function testPassInBool() public {
        bool result;
        /// @solidity memory-safe-assembly
        assembly {
            mstore(0x00, 0x59a3028a)
            mstore(0x20, 1)
            pop(staticcall(gas(), address(), 0x1c, 0x24, 0x00, 0x20))
            result := eq(mload(0x00), 1)
        }
        assertTrue(result);
    }

    function acceptsBool(bool) public pure returns (bool) {
        return true;
    }

    function testBoolToUint(bool b) public {
        uint256 z;
        /// @solidity memory-safe-assembly
        assembly {
            z := b
        }
        assertEq(LibBit.toUint(b), z);
        assertEq(LibBit.rawToUint(b), z);
    }

    function testReverseBits() public {
        uint256 x = 0xf2e857a5b8e3fec9f9c60ae71ba63813c96741bc837169cf0f29f113ede5956f;
        uint256 r = 0xf6a9a7b7c88f94f0f3968ec13d82e693c81c65d8e750639f937fc71da5ea174f;
        assertEq(LibBit.reverseBits(x), r);
        unchecked {
            for (uint256 i; i < 256; ++i) {
                assertEq(LibBit.reverseBits(1 << i), (1 << 255) >> i);
            }
        }
    }

    function testReverseBitsDifferential(uint256 x) public {
        assertEq(LibBit.reverseBits(x), _reverseBitsOriginal(x));
    }

    function _reverseBitsOriginal(uint256 x) internal pure returns (uint256 r) {
        unchecked {
            for (uint256 i; i != 256; ++i) {
                r = (r << 1) | ((x >> i) & 1);
            }
        }
    }

    function testReverseBytes() public {
        uint256 x = 0x112233445566778899aa112233445566778899aa112233445566778899aa1122;
        uint256 r = 0x2211aa998877665544332211aa998877665544332211aa998877665544332211;
        assertEq(LibBit.reverseBytes(x), r);
        unchecked {
            for (uint256 i; i < 256; i += 8) {
                assertEq(LibBit.reverseBytes(0xff << i), (0xff << 248) >> i);
            }
        }
    }

    function testReverseBytesDifferential(uint256 x) public {
        assertEq(LibBit.reverseBytes(x), _reverseBytesOriginal(x));
    }

    function _reverseBytesOriginal(uint256 x) internal pure returns (uint256 r) {
        /// @solidity memory-safe-assembly
        assembly {
            for { let i := 0 } lt(i, 32) { i := add(i, 1) } { mstore8(i, byte(sub(31, i), x)) }
            r := mload(0x00)
        }
    }

    function testCommonNibblePrefix() public {
        assertEq(LibBit.commonNibblePrefix(0x1, 0x2), 0);
        assertEq(LibBit.commonNibblePrefix(0x1234abc, 0x1234bbb), 0x1234000);
        assertEq(LibBit.commonNibblePrefix(0x1234abc, 0x1234abc), 0x1234abc);
    }

    function testCommonNibblePrefixDifferential(uint256 x, uint256 y) public {
        assertEq(LibBit.commonNibblePrefix(x, y), _commonNibblePrefixOriginal(x, y));
    }

    function _commonNibblePrefixOriginal(uint256 x, uint256 y) internal pure returns (uint256 z) {
        uint256 m = 0xf000000000000000000000000000000000000000000000000000000000000000;
        while (m != 0) {
            if ((x & m) == (y & m)) z |= x & m;
            else break;
            m >>= 4;
        }
    }

    function testCommonBytePrefix() public {
        assertEq(LibBit.commonBytePrefix(0xaabbcc, 0xaabbcc), 0xaabbcc);
        assertEq(LibBit.commonBytePrefix(0xaabbcc, 0xaabbc0), 0xaabb00);
        assertEq(LibBit.commonBytePrefix(0xaabbcc, 0xaab0c0), 0xaa0000);
        assertEq(LibBit.commonBytePrefix(0xaabbcc, 0xa0b0c0), 0x000000);
    }

    function testCommonBytePrefixDifferential(uint256 x, uint256 y) public {
        assertEq(LibBit.commonBytePrefix(x, y), _commonBytePrefixOriginal(x, y));
    }

    function _commonBytePrefixOriginal(uint256 x, uint256 y) internal pure returns (uint256 z) {
        uint256 m = 0xff00000000000000000000000000000000000000000000000000000000000000;
        while (m != 0) {
            if ((x & m) == (y & m)) z |= x & m;
            else break;
            m >>= 8;
        }
    }

    function testCommonBitPrefixDifferential(uint256 x, uint256 y) public {
        assertEq(LibBit.commonBitPrefix(x, y), _commonBitPrefixOriginal(x, y));
    }

    function _commonBitPrefixOriginal(uint256 x, uint256 y) internal pure returns (uint256 z) {
        uint256 m = 0x8000000000000000000000000000000000000000000000000000000000000000;
        while (m != 0) {
            if ((x & m) == (y & m)) z |= x & m;
            else break;
            m >>= 1;
        }
    }

    function testCountZeroBytesDifferential(uint256 x) public {
        assertEq(LibBit.countZeroBytes(x), _countZeroBytesOriginal(x));
    }

    function testCountZeroBytes() public {
        uint256 x = 0xff00ffffffffffffffffffffffffffffffffffffffffffffffffffffffff00ff;
        x |= uint256(uint160(address(this))) << 16;
        assertEq(LibBit.countZeroBytes(x), 2);
    }

    function _countZeroBytesOriginal(uint256 x) internal pure returns (uint256 c) {
        unchecked {
            for (uint256 i; i < 32; ++i) {
                c += (x & (0xff << (i * 8))) == 0 ? 1 : 0;
            }
            return c;
        }
    }

    function testCountZeroBytesDifferential(bytes32) public {
        testCountZeroBytesDifferential(_randomSmallBytes());
    }

    function testCountZeroBytesDifferential(bytes memory s) public {
        assertEq(LibBit.countZeroBytes(s), _countZeroBytesOriginal(s));
    }

    function testCountZeroBytesCalldataDifferential(bytes32) public {
        this.testCountZeroBytesCalldataDifferential(_randomSmallBytes());
    }

    function testCountZeroBytesCalldataDifferential(bytes calldata s) public {
        assertEq(LibBit.countZeroBytesCalldata(s), _countZeroBytesOriginal(s));
    }

    function _countZeroBytesOriginal(bytes memory s) internal pure returns (uint256 c) {
        unchecked {
            for (uint256 i; i < s.length; ++i) {
                c += uint8(s[i]) == 0 ? 1 : 0;
            }
            return c;
        }
    }

    function _randomSmallBytes() internal returns (bytes memory) {
        uint256 n = _bound(_random(), 0, 100);
        uint256 r = _randomUniform();
        uint256 x = r >> 248;
        bytes memory s = new bytes(n);
        /// @solidity memory-safe-assembly
        assembly {
            mstore(0x00, r)
            for { let i := 0 } lt(i, n) { i := add(i, 1) } {
                if and(1, shr(i, r)) { mstore8(add(add(s, 0x20), i), x) }
            }
        }
        return s;
    }

    function testToNibblesGas() public {
        bytes memory s = hex"123456789abcdef123456789abcdef123456789abcdef123456789abcdef";
        bytes memory expected =
            hex"0102030405060708090a0b0c0d0e0f0102030405060708090a0b0c0d0e0f0102030405060708090a0b0c0d0e0f0102030405060708090a0b0c0d0e0f";
        assertEq(LibBit.toNibbles(s), expected);

        bytes memory s1 =
            hex"6080604052600436106100b15760003560e01c8063545e7c611161006957806399a88ec41161004e57806399a88ec41461019d578063a97b90d5146101b0578063db4c545e146101c357600080fd5b8063545e7c61146101775780639623609d1461018a57600080fd5b80633729f9221161009a5780633729f922146101315780634314f120146101445780635414dff01461015757600080fd5b80631acfd02a146100b65780632abbef15146100d8575b600080fd5b3480156100c257600080fd5b506100d66100d1366004610604565b6101e6565b005b3480156100e457600080fd5b506101076100f3366004610637565b30600c908152600091909152602090205490565b60405173ffffffffffffffffffffffffffffffffffffffff90911681526020015b60405180910390f35b61010761013f366004610652565b610237565b6101076101523660046106d7565b61024e565b34801561016357600080fd5b50610107610172366004610738565b610267565b610107610185366004610604565b61029a565b6100d66101983660046106d7565b6102af565b6100d66101ab366004610604565b61035f565b6101076101be366004610751565b610370565b3480156101cf57600080fd5b506101d86103a9565b604051908152602001610128565b30600c52816000526020600c2033815414610209576382b429006000526004601cfd5b81905580827f7e644d79422f17c01e4894b5f4f588d331ebfa28653d42ae832dc59e38c9798f600080a35050565b60006102468484843685610370565b949350505050565b600061025e8585838087876103c2565b95945050505050565b6000806102726103a9565b905060ff600053806035523060601b6001528260155260556000209150600060355250919050565b60006102a88383368461024e565b9392505050565b30600c5283600052336020600c2054146102d1576382b429006000526004601cfd5b6040518381527f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc602082015281836040830137600080836040018334895af1610331573d610327576355299b496000526004601cfd5b3d6000803e3d6000fd5b5082847f5d611f318680d00598bb735d61bacf0c514c6b50e1e5ad30040a4df2b12791c7600080a350505050565b61036c82823660006102af565b5050565b60008360601c33148460601c151761039057632f6348366000526004601cfd5b61039f868686600187876103c2565b9695505050505050565b6000806103b461049c565b608960139091012092915050565b6000806103cd61049c565b90508480156103e757866089601384016000f592506103f3565b6089601383016000f092505b50816104075763301164256000526004601cfd5b8781527f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc602082015282846040830137600080846040018334865af161045a573d6103275763301164256000526004601cfd5b30600c5281600052866020600c20558688837fc95935a66d15e0da5e412aca0ad27ae891d20b2fb91cf3994b6a3bf2b8178082600080a4509695505050505050565b6040513060701c801561054257666052573d6000fd607b8301527f3d356020355560408036111560525736038060403d373d3d355af43d6000803e60748301527f3735a920a3ca505d382bbc545af43d6000803e6052573d6000fd5b3d6000f35b60548301527f14605757363d3d37363d7f360894a13ba1a3210667c828492db98dca3e2076cc60348301523060148301526c607f3d8160093d39f33d3d337382525090565b66604c573d6000fd60758301527f3d3560203555604080361115604c5736038060403d373d3d355af43d6000803e606e8301527f3735a920a3ca505d382bbc545af43d6000803e604c573d6000fd5b3d6000f35b604e8301527f14605157363d3d37363d7f360894a13ba1a3210667c828492db98dca3e2076cc602e83015230600e8301526c60793d8160093d39f33d3d336d82525090565b803573ffffffffffffffffffffffffffffffffffffffff811681146105ff57600080fd5b919050565b6000806040838503121561061757600080fd5b610620836105db565b915061062e602084016105db565b90509250929050565b60006020828403121561064957600080fd5b6102a8826105db565b60008060006060848603121561066757600080fd5b610670846105db565b925061067e602085016105db565b9150604084013590509250925092565b60008083601f8401126106a057600080fd5b50813567ffffffffffffffff8111156106b857600080fd5b6020830191508360208285010111156106d057600080fd5b9250929050565b600080600080606085870312156106ed57600080fd5b6106f6856105db565b9350610704602086016105db565b9250604085013567ffffffffffffffff81111561072057600080fd5b61072c8782880161068e565b95989497509550505050565b60006020828403121561074a57600080fd5b5035919050565b60008060008060006080868803121561076957600080fd5b610772866105db565b9450610780602087016105db565b935060408601359250606086013567ffffffffffffffff8111156107a357600080fd5b6107af8882890161068e565b96999598509396509294939250505056fea26469706673582212200ac7c3ccbc2d311c48bf5465b021542e0e306fe3c462c060ba6a3d2f81ff6c5f64736f6c63430008130033";
        bytes memory expected1 =
            hex"060008000600040005020600000403060100060100000b01050706000000030506000e00010c080006030504050e070c0601010106010000060905070800060309090a08080e0c04010106010000040e05070800060309090a08080e0c04010406010001090d0507080006030a09070b09000d050104060100010b000507080006030d0b040c0504050e0104060100010c0305070600000008000f0d050b080006030504050e070c06010104060100010707050708000603090602030600090d010406010001080a05070600000008000f0d050b08000603030702090f090202010106010000090a050708000603030702090f0902020104060100010301050708000603040301040f0102000104060100010404050708000603050401040d0f0f00010406010001050705070600000008000f0d050b08000603010a0c0f0d00020a0104060100000b06050708000603020a0b0b0e0f01050104060100000d080507050b0600000008000f0d050b030408000105060100000c0205070600000008000f0d050b0500060100000d06060100000d010306060000040601000600040506050b060100010e060506050b0000050b030408000105060100000e0405070600000008000f0d050b0500060100010007060100000f030306060000040601000603070506050b03000600000c0900080105020600000009010900090105020600020009000200050409000506050b06000400050107030f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f09000901010608010502060002000001050b06000400050108000901000309000f03050b06010001000706010001030f0306060000040601000605020506050b0601000203070506050b060100010007060100010502030606000004060100060d070506050b06010002040e0506050b03040800010506010001060305070600000008000f0d050b05000601000100070601000107020306060000040601000703080506050b0601000206070506050b0601000100070601000108050306060000040601000600040506050b06010002090a0506050b060100000d06060100010908030606000004060100060d070506050b060100020a0f0506050b060100000d06060100010a0b0306060000040601000600040506050b06010003050f0506050b060100010007060100010b0e0306060000040601000705010506050b0601000307000506050b030408000105060100010c0f05070600000008000f0d050b0500060100010d08060100030a090506050b0600040005010900080105020600020000010601000102080506050b03000600000c05020801060000000502060002000600000c020003030801050401040601000200090507060308020b0402090000060000000502060000040600010c0f0d050b08010900050508000802070f070e0604040d07090402020f01070c00010e040809040b050f040f0508080d0303010e0b0f0a02080605030d04020a0e0803020d0c05090e03080c090709080f0600000008000a03050005000506050b06000000060100020406080408040804030608050601000307000506050b0904090305000500050005000506050b0600000006010002050e080508050803080008070807060100030c020506050b09050904050005000500050005000506050b060000000800060100020702060100030a090506050b0900050006000f0f0600000005030800060003050502030006000600010b060000010502080206000105050206000505060000000200090105000600000006000305050205000901090005000506050b06000000060100020a08080308030306080406010002040e0506050b090309020500050005000506050b03000600000c050208030600000005020303060002000600000c020005040104060100020d010507060308020b0402090000060000000502060000040600010c0f0d050b060004000501080308010502070f0306000809040a01030b0a010a030201000606070c0802080409020d0b09080d0c0a030e020007060c0c030703050a0902000a030c0a0500050d0308020b0b0c0600020008020001050208010803060004000803000103070600000008000803060004000001080303040809050a0f010601000303010507030d0601000302070507060305050209090b0409060000000502060000040600010c0f0d050b030d060000000800030e030d060000000f0d050b050008020804070f050d0601010f0301080608000d00000509080b0b0703050d06010b0a0c0f000c0501040c060b05000e010e050a0d03000004000a040d0f020b01020709010c070600000008000a0305000500050005000506050b06010003060c08020802030606000000060100020a0f0506050b050005000506050b06000000080306000600010c03030104080406000600010c0105010706010003090005070603020f060304080306060000000502060000040600010c0f0d050b06010003090f0806080608060600000108070807060100030c020506050b090609050500050005000500050005000506050b060000000800060100030b0406010004090c0506050b0600080906000103090009010001020009020901050005000506050b060000000800060100030c0d06010004090c0506050b09000500080408000105060100030e0705070806060008090600010308040001060000000f0509020500060100030f030506050b060008090600010308030001060000000f0009020500050b05000801060100040007050706030300010106040205060000000502060000040600010c0f0d050b080708010502070f0306000809040a01030b0a010a030201000606070c0802080409020d0b09080d0c0a030e020007060c0c030703050a0902000a030c0a0500050d0308020b0b0c0600020008020001050208020804060004000803000103070600000008000804060004000001080303040806050a0f0106010004050a0507030d060100030207050706030300010106040205060000000502060000040600010c0f0d050b03000600000c050208010600000005020806060002000600000c02000505080608080803070f0c09050903050a06060d01050e000d0a050e0401020a0c0a000a0d02070a0e0809010d02000b020f0b09010c0f030909040b060a030b0f020b080107080008020600000008000a040500090609050500050005000500050005000506050b060004000501030006000700010c0800010506010005040205070606060005020507030d060000000f0d0600070b080300010502070f030d0305060002000305050506000400080003060101010506000502050703060003080006000400030d0307030d030d0305050a0f04030d060000000800030e06000704080300010502070f030703050a0902000a030c0a0500050d0308020b0b0c0504050a0f04030d060000000800030e060005020507030d060000000f0d050b030d060000000f03050b06000504080300010502070f01040600050705070306030d030d03070306030d070f0306000809040a01030b0a010a030201000606070c0802080409020d0b09080d0c0a030e020007060c0c06000304080300010502030006000104080300010502060c0600070f030d080106000009030d03090f03030d030d0303070308020502050009000506050b06060600040c0507030d060000000f0d06000705080300010502070f030d030506000200030505050600040008000306010101050600040c050703060003080006000400030d0307030d030d0305050a0f04030d060000000800030e0600060e080300010502070f030703050a0902000a030c0a0500050d0308020b0b0c0504050a0f04030d060000000800030e0600040c0507030d060000000f0d050b030d060000000f03050b0600040e080300010502070f01040600050105070306030d030d03070306030d070f0306000809040a01030b0a010a030201000606070c0802080409020d0b09080d0c0a030e020007060c0c0600020e08030001050203000600000e080300010502060c06000709030d080106000009030d03090f03030d030d0303060d08020502050009000506050b0800030507030f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0801010608010104060100050f0f05070600000008000f0d050b0901090005000506050b060000000800060004000803080500030102010506010006010705070600000008000f0d050b0601000602000803060100050d0b0506050b0901050006010006020e0600020008040001060100050d0b0506050b09000500090205000902090005000506050b06000000060002000802080400030102010506010006040905070600000008000f0d050b060100020a080802060100050d0b0506050b06000000080006000000060006000804080600030102010506010006060705070600000008000f0d050b0601000607000804060100050d0b0506050b0902050006010006070e0600020008050001060100050d0b0506050b090105000600040008040001030509000500090205000902050009020506050b06000000080008030600010f080400010102060100060a0005070600000008000f0d050b05000801030506070f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f080101010105060100060b0805070600000008000f0d050b060002000803000109010500080306000200080208050001000101010105060100060d0005070600000008000f0d050b090205000902090005000506050b0600000008000600000008000600060008050807000301020105060100060e0d05070600000008000f0d050b060100060f060805060100050d0b0506050b090305000601000700040600020008060001060100050d0b0506050b090205000600040008050001030506070f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f08010101010506010007020005070600000008000f0d050b06010007020c080708020808000106010006080e0506050b09050908090409070500090505000500050005000506050b06000000060002000802080400030102010506010007040a05070600000008000f0d050b050003050901090005000506050b06000000080006000000080006000000060008000806080800030102010506010007060905070600000008000f0d050b0601000707020806060100050d0b0506050b090405000601000708000600020008070001060100050d0b0506050b0903050006000400080600010305090205000600060008060001030506070f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f080101010105060100070a0305070600000008000f0d050b060100070a0f080808020809000106010006080e0506050b09060909090509080500090309060500090209040903090205000500050005060f0e0a02060406090700060607030508020201020200000a0c070c030c0c0b0c020d0301010c04080b0f050406050b0002010504020e000e0300060f0e030c0406020c0006000b0a060a030d020f08010f0f060c050f06040703060f060c0603040300000008010300000303";
        assertEq(LibBit.toNibbles(s1), expected1);
    }

    function testToNibblesDifferential(uint256 r, bytes memory s) public {
        if (r & 0x01 == 0) {
            _brutalizeMemory();
            _misalignFreeMemoryPointer();
        }
        bytes memory computed = LibBit.toNibbles(s);
        _checkMemory(computed);
        assertEq(computed, _toNibblesOriginal(s));
    }

    // Original code from Optimism (MIT-licensed): https://github.com/ethereum-optimism/optimism/blob/1bfc93f7c1fe1846217795a1f6051e1b0260f597/packages/contracts-bedrock/src/libraries/Bytes.sol#L94
    function _toNibblesOriginal(bytes memory input) internal pure returns (bytes memory result) {
        /// @solidity memory-safe-assembly
        assembly {
            result := mload(0x40)
            let bytesLength := mload(input)
            let nibblesLength := shl(0x01, bytesLength)
            mstore(0x40, add(result, and(not(0x1f), add(nibblesLength, 0x3f))))
            mstore(result, nibblesLength)
            let bytesStart := add(input, 0x20)
            let nibblesStart := add(result, 0x20)
            for { let i := 0x00 } lt(i, bytesLength) { i := add(i, 0x01) } {
                let offset := add(nibblesStart, shl(0x01, i))
                let b := byte(0x00, mload(add(bytesStart, i)))
                mstore8(offset, shr(0x04, b))
                mstore8(add(offset, 0x01), and(b, 0x0F))
            }
        }
    }
}
